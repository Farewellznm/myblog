---
title: "R大数据读写优化参考"
author: "LHS"
date: "2021-08-02"
category: R
tags: 
- R
output: html_document
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="优化和读取数据" class="section level2">
<h2>1.优化和读取数据</h2>
<p>R基础函数<code>read.csv</code>和类似的函数适合小数据集，由于其灵活性，使用的很多；但是对于大数据集，这些函数使用起来耗时过多和耗内存过多。</p>
<p><code>readr</code>提供了很多R基础函数的补充，用‘_’代替‘.’用于常用文件的读取。</p>
<ol style="list-style-type: decimal">
<li><p>read_delim：读取带分隔符的文件</p>
<ul>
<li><p>read_csv:普通的</p></li>
<li><p>read_tsv:tab分隔的</p></li>
</ul></li>
<li><p>read_lines:按行读取</p></li>
<li><p>read_file: 按string读入整个文件</p></li>
</ol>
</div>
<div id="调整数据存储结构" class="section level2">
<h2>2.调整数据存储结构</h2>
<p>稀疏矩阵比密集矩阵使用更少的内存</p>
<pre class="r"><code># A large matrix 

set.seed(2021)

m &lt;- Matrix::sparseMatrix(i = sample(x = 1e4, size  = 1e4),
                  j = sample(x = 1e4, size = 1e4),
                  x = rnorm(n = 1e4)
                  )
pryr::object_size(m)</code></pre>
<pre><code>## 161,504 B</code></pre>
<pre class="r"><code>pryr::object_size(as.matrix(m))</code></pre>
<pre><code>## 800,000,392 B</code></pre>
<p>结果表明稀疏矩阵大小为 132 Kb ；比密集矩阵 800 Mb 小很多。</p>
</div>
<div id="调整大内存读写r包" class="section level2">
<h2>3.调整大内存读写R包</h2>
<p>例如使用<code>filematrix</code>代替<code>bigmemory</code>对矩阵读写。<code>filematrix</code>读写无延迟，适合大矩阵；·<code>bigmemory</code>文件关闭时再进行写操作，对于小矩阵的访问更好。</p>
<p>考虑一个简单的任务：填满一个大矩阵（内存大小的两倍），比较两个包：</p>
<pre class="r"><code>library(filematrix)
fm = fm.create(
        filenamebase = &quot;big_fm&quot;,
        nrow = 1e5,
        ncol = 1e5)

tic = proc.time()
for( i in seq_len(ncol(fm)) ) {
    message(i, &quot; of &quot;, ncol(fm))
    fm[,i] = i + 1:nrow(fm)
}
toc = proc.time()
show(toc-tic)

# Cleanup

closeAndDeleteFiles(fm)</code></pre>
</div>
<div id="使用高性能函数" class="section level2">
<h2>4.使用高性能函数</h2>
<p>使用<code>bench::mark</code>来标出不同函数的性能，尽量编写高性能函数。</p>
<pre class="r"><code>mean1 &lt;- function(x) mean(x)

mean2 &lt;- function(x) sum(x) / length(x)

x &lt;- runif(1e5)

bench::mark(
  mean1(x),
  mean2(x)
)[c(&quot;expression&quot;, &quot;min&quot;, &quot;median&quot;, &quot;itr/sec&quot;, &quot;n_gc&quot;)]</code></pre>
<pre><code>## # A tibble: 2 x 4
##   expression      min   median `itr/sec`
##   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt;
## 1 mean1(x)    143.1us  143.4us     6807.
## 2 mean2(x)     70.7us   72.2us    13566.</code></pre>
</div>
<div id="ref" class="section level2">
<h2>Ref</h2>
<p>[1] FastR, <a href="https://m-clark.github.io/docs/fastr.html" class="uri">https://m-clark.github.io/docs/fastr.html</a></p>
<p>[2] 稀疏矩阵表示，<a href="https://slowkow.com/notes/sparse-matrix/" class="uri">https://slowkow.com/notes/sparse-matrix/</a></p>
<p>[3] Filematrix vs bigmemory可参考链接：<a href="https://cran.r-project.org/web/packages/filematrix/vignettes/FM3_filematrix_vs_bigmemory.html" class="uri">https://cran.r-project.org/web/packages/filematrix/vignettes/FM3_filematrix_vs_bigmemory.html</a></p>
<p>[4] bench 包 优化 <a href="https://adv-r.hadley.nz/perf-improve.html" class="uri">https://adv-r.hadley.nz/perf-improve.html</a></p>
</div>
