---
title: "单细胞流程:Lineage Inference"
author: "LHS"
date: "2021-06-20"
category: 单细胞
tags: 
- 单细胞
output: html_document
draft: true
---

# 单细胞谱系推断 Lineage Inference

1. 介绍与原理

单细胞流程重要的一步是谱系构建（lineage reconstruction ）和伪时序构建（pseudotime inference）。slingshot的目标是利用细胞集群来发现全局结构，并将这种结构转化为由一维变量表示的平滑线段，称为 "伪时间"。

```{r echo=T, results='hide',message=FALSE,warning=FALSE}
library(devtools)
devtools::install_github("SONGDONGYUAN1994/PseudotimeDE")
#
library(PseudotimeDE)
library(SingleCellExperiment)
```


```{r}

means <- rbind(
    # non-DE genes
    matrix(rep(rep(c(0.1,0.5,1,2,3), each = 300),100),
        ncol = 300, byrow = TRUE),
    # early deactivation
    matrix(rep(exp(atan( ((300:1)-200)/50 )),50), ncol = 300, byrow = TRUE),
    # late deactivation
    matrix(rep(exp(atan( ((300:1)-100)/50 )),50), ncol = 300, byrow = TRUE),
    # early activation
    matrix(rep(exp(atan( ((1:300)-100)/50 )),50), ncol = 300, byrow = TRUE),
    # late activation
    matrix(rep(exp(atan( ((1:300)-200)/50 )),50), ncol = 300, byrow = TRUE),
    # transient
    matrix(rep(exp(atan( c((1:100)/33, rep(3,100), (100:1)/33) )),50), 
        ncol = 300, byrow = TRUE)
)
counts <- apply(means,2,function(cell_means){
    total <- rnbinom(1, mu = 7500, size = 4)
    rmultinom(1, total, cell_means)
})
rownames(counts) <- paste0('G',1:750)
colnames(counts) <- paste0('c',1:300)
sim <- SingleCellExperiment(assays = List(counts = counts))


```


```{r echo=T,message=FALSE,warning=FALSE}

library(slingshot, quietly = FALSE)
data("slingshotExample")
rd <- slingshotExample$rd
cl <- slingshotExample$cl

dim(rd) # data representing cells in a reduced dimensional space
```


```{r}

# filter genes down to potential cell-type markers
# at least M (15) reads in at least N (15) cells
geneFilter <- apply(assays(sim)$counts,1,function(x){
    sum(x >= 3) >= 10
})
sim <- sim[geneFilter, ]

```

```{r}
FQnorm <- function(counts){
    rk <- apply(counts,2,rank,ties.method='min')
    counts.sort <- apply(counts,2,sort)
    refdist <- apply(counts.sort,1,median)
    norm <- apply(rk,2,function(r){ refdist[r] })
    rownames(norm) <- rownames(counts)
    return(norm)
}
assays(sim)$norm <- FQnorm(assays(sim)$counts)
```

```{r pca}
pca <- prcomp(t(log1p(assays(sim)$norm)), scale. = FALSE)
rd1 <- pca$x[,1:2]
plot(rd1, col = rgb(0,0,0,.5), pch=16, asp = 1)
```

UMAP（统一流形近似和投影）是一种新颖的流形学习技术，用于降维。UMAP由基于黎曼几何和代数拓扑的理论框架构建而成。结果是适用于现实世界数据的实用的可伸缩算法。UMAP算法在可视化质量上与t-SNE竞争，并且可以说以优异的运行时性能保留了更多的全局结构。此外，UMAP对嵌入维数没有计算限制，使其成为用于机器学习的通用降维技术是可行的.

```{r echo=T,message=FALSE,warning=FALSE}
library(uwot)

rd2 <- umap(t(log1p(assays(sim)$norm)))
colnames(rd2) <- c('UMAP1', 'UMAP2')
plot(rd2)
reducedDims(sim) <- SimpleList(PCA = rd1, UMAP = rd2)
```

```{r}
library(mclust, quietly = TRUE)
cl1 <- Mclust(rd1)$classification
colData(sim)$GMM <- cl1
library(RColorBrewer)
plot(rd1, col = brewer.pal(9,"Set1")[cl1], pch=16, asp = 1)

# kmeans 聚类数目的不同会影响拟时序的精度，太少不能反应真实谱系发育过程；太多会产生过多假阳性分支
cl2 <- kmeans(rd1, centers = 4)$cluster
colData(sim)$kmeans <- cl2

plot(rd1, col = brewer.pal(9,"Set1")[cl2], pch=16, asp = 1)
```

Slingshot通过两个函数`getLineages` and `getCurves`来实现 1）谱系构建cluster-based minimum spanning tree (MST) ；2）曲线拟合;这一步可以结合之前注释的细胞标签cluster labels

```{r slingshot}
sim <- slingshot(sim, clusterLabels = 'GMM', reducedDim = 'PCA')
summary(sim$slingPseudotime_1)
colors <- colorRampPalette(brewer.pal(11,'Spectral')[-6])(100)
plotcol <- colors[cut(sim$slingPseudotime_1, breaks=100)]
plot(reducedDims(sim)$PCA, col = plotcol, pch=16, asp = 1)
lines(SlingshotDataSet(sim), lwd=2, col='black')

plot(reducedDims(sim)$PCA, col = brewer.pal(9,'Set1')[sim$GMM], pch=16, asp = 1)
lines(SlingshotDataSet(sim), lwd=2, type = 'lineages', col = 'black')

```


```{r DE}
library(PseudotimeDE)
library(tradeSeq)
sim <- fitGAM(sim)
ATres <- associationTest(sim)
topgenes <- rownames(ATres[order(ATres$pvalue), ])[1:250]
pst.ord <- order(sim$slingPseudotime_1, na.last = NA)
heatdata <- assays(sim)$counts[topgenes, pst.ord]
heatclus <- sim$GMM[pst.ord]

heatmap(log1p(heatdata), Colv = NA,
        ColSideColors = brewer.pal(9,"Set1")[heatclus])

```









# Ref

李婧翌老师报告的slides ：http://jsb.ucla.edu/selected-presentations